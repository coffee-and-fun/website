<!DOCTYPE html>
<html class="scroll-smooth antialiased" lang="en" data-theme="retro">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tactical Chess - Chess with Power-Ups</title>

    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Scripts -->
    <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>

    <style>
      [v-cloak] { display: none; }

      * {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body {
        background: linear-gradient(135deg, #fef5e7 0%, #fef9f3 100%);
      }

      .chess-board {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        grid-template-rows: repeat(8, 1fr);
        width: 100%;
        max-width: min(65vw, 520px);
        aspect-ratio: 1;
        margin: 0 auto;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 
          0 20px 60px rgba(0, 0, 0, 0.15),
          0 8px 24px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      @media (max-width: 1280px) {
        .chess-board { max-width: min(75vw, 480px); }
      }

      @media (max-width: 1024px) {
        .chess-board { max-width: min(85vw, 450px); }
      }

      @media (max-width: 768px) {
        .chess-board { max-width: min(92vw, 420px); }
      }

      .chess-square {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(1.5rem, 3.2vw, 2.5rem);
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        -webkit-tap-highlight-color: transparent;
      }

      .chess-square.light {
        background: linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%);
      }

      .chess-square.dark {
        background: linear-gradient(135deg, #e8e8e8 0%, #d8d8d8 100%);
      }
      
      .chess-square.selected {
        background: linear-gradient(135deg, #34c759 0%, #30d158 100%) !important;
        box-shadow: 
          inset 0 0 0 3px rgba(255, 255, 255, 0.5),
          0 4px 12px rgba(52, 199, 89, 0.3);
        transform: scale(0.95);
      }

      .chess-square.valid-move::after {
        content: '';
        position: absolute;
        width: 22%;
        height: 22%;
        border-radius: 50%;
        background: rgba(52, 199, 89, 0.5);
        box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
      }

      .chess-square.valid-move.has-piece::after {
        width: 80%;
        height: 80%;
        border: 4px solid rgba(255, 59, 48, 0.6);
        background: transparent;
        box-shadow: 0 2px 12px rgba(255, 59, 48, 0.3);
      }

      .chess-square:hover:not(.selected) {
        background: rgba(0, 0, 0, 0.03);
        transform: scale(0.98);
      }

      .chess-square:active:not(.selected) {
        transform: scale(0.95);
      }

      .chess-piece {
        user-select: none;
        pointer-events: none;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.12));
      }

      .flash-effect {
        animation: flash 0.45s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes flash {
        0%, 100% { transform: scale(1); }
        50% { 
          transform: scale(1.12);
          background: rgba(255, 204, 0, 0.2);
        }
      }

      .captured-pieces {
        min-height: 64px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        border: 1px solid rgba(0, 0, 0, 0.04);
        align-content: flex-start;
      }

      .captured-piece {
        font-size: 1.5rem;
        opacity: 0.5;
        transition: all 0.2s;
      }

      .captured-piece:hover {
        opacity: 0.85;
        transform: scale(1.1);
      }

      .card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 20px;
        box-shadow: 
          0 8px 32px rgba(0, 0, 0, 0.08),
          0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .btn btn-soft {
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
      }

      .btn:active:not(:disabled) {
        transform: translateY(0);
      }

      .modal-box {
        border-radius: 24px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(30px);
        box-shadow: 
          0 24px 80px rgba(0, 0, 0, 0.25),
          0 8px 24px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      .badge {
        border-radius: 999px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .navbar {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-slide-up {
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
    </style>
  </head>

  <body>
    <div id="app" v-cloak>
      <!-- Navbar -->
      <nav class="navbar sticky top-0 z-50" role="navigation">
        <div class="navbar-start">
          <h1 class="text-lg md:text-xl font-bold normal-case">
            ‚ôüÔ∏è Tactical Chess
          </h1>
        </div>

        <div class="navbar-center hidden md:flex">
          <div class="badge badge-lg" :class="{
            'badge-primary': currentPlayer === 'white',
            'badge-secondary': currentPlayer === 'black'
          }">
            <span class="text-lg">{% raw %}{{ currentPlayer === 'white' ? '‚ôî' : '‚ôö' }}{% endraw %}</span>
            <span class="ml-2">{% raw %}{{ currentPlayer === 'white' ? "White's" : "Black's" }}{% endraw %} Turn</span>
          </div>
        </div>

        <div class="navbar-end gap-2">
          <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-soft btn-sm btn-outline md:btn-md gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 -960 960 960" fill="currentColor">
                <path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/>
              </svg>
              <span class="hidden md:inline">{% raw %}{{ gameMode === 'local' ? 'Local' : 'Online' }}{% endraw %}</span>
            </label>
            <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-base-100 rounded-box w-52 mt-2">
              <li><a @click="setGameMode('local')" :class="{'active': gameMode === 'local'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 -960 960 960" fill="currentColor">
                  <path d="M0-240v-63q0-43 44-70t116-27q13 0 25 .5t23 2.5q-14 21-21 44t-7 48v65H0Zm240 0v-65q0-32 17.5-58.5T307-410q32-20 76.5-30t96.5-10q53 0 97.5 10t76.5 30q32 20 49 46.5t17 58.5v65H240Zm540 0v-65q0-26-6.5-49T754-397q11-2 22.5-2.5t23.5-.5q72 0 116 26.5t44 70.5v63H780Z"/>
                </svg>
                Local Play
              </a></li>
              <li><a @click="setGameMode('multiplayer')" :class="{'active': gameMode === 'multiplayer'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 -960 960 960" fill="currentColor">
                  <path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/>
                </svg>
                Multiplayer
              </a></li>
            </ul>
          </div>

          <button @click="showRulesModal" class="btn btn-soft btn-ghost btn-sm md:btn-md btn-circle">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 -960 960 960" fill="currentColor">
              <path d="M478-240q21 0 35.5-14.5T528-290q0-21-14.5-35.5T478-340q-21 0-35.5 14.5T428-290q0 21 14.5 35.5T478-240Zm-36-154h74q0-33 7.5-52t42.5-52q26-26 41-49.5t15-56.5q0-56-41-86t-97-30q-57 0-92.5 30T342-618l66 26q5-18 22.5-39t53.5-21q32 0 48 17.5t16 38.5q0 20-12 37.5T506-526q-44 39-54 59t-10 73Z"/>
            </svg>
          </button>
        </div>
      </nav>

      <!-- Mobile Turn Indicator -->
      <div class="flex md:hidden justify-center py-3 px-4">
        <div class="badge badge-lg" :class="{
          'badge-primary': currentPlayer === 'white',
          'badge-secondary': currentPlayer === 'black'
        }">
          <span class="text-lg">{% raw %}{{ currentPlayer === 'white' ? '‚ôî' : '‚ôö' }}{% endraw %}</span>
          <span class="ml-2">{% raw %}{{ currentPlayer === 'white' ? "White's" : "Black's" }}{% endraw %} Turn</span>
        </div>
      </div>

      <!-- Winner Alert -->
      <div v-if="winner" class="container mx-auto px-4 py-4 animate-slide-up">
        <div class="alert alert-success shadow-lg max-w-md mx-auto">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="font-bold">{% raw %}{{ winner === 'white' ? '‚ôî White' : '‚ôö Black' }}{% endraw %} Wins!</span>
        </div>
      </div>

      <!-- Main Game Layout -->
      <main class="container mx-auto px-3 md:px-4 py-4 md:py-6 max-w-[1400px]">
        <div class="grid grid-cols-1 xl:grid-cols-[280px_1fr_280px] gap-4 md:gap-6 items-stretch">
          
          <!-- Left Column - Black Captured -->
          <div class="order-2 xl:order-1 animate-slide-up h-full" style="animation-delay: 0.1s">
            <div class="h-full bg-gradient-to-br from-base-100/60 to-base-100/40 backdrop-blur-xl rounded-3xl border border-base-content/5 p-5">
              <h3 class="font-bold text-lg flex items-center gap-2 mb-4">
                <span class="text-3xl">‚ôö</span>
                <span>Black</span>
              </h3>
              <div class="captured-pieces">
                <span v-for="(piece, index) in capturedPieces.black" :key="'black-' + index" class="captured-piece">
                  {% raw %}{{ piece }}{% endraw %}
                </span>
                <span v-if="capturedPieces.black.length === 0" class="text-sm opacity-40">No captures</span>
              </div>
            </div>
          </div>

          <!-- Center Column - Chess Board & Controls -->
          <div class="order-1 xl:order-2 animate-slide-up">
            <!-- Chess Board -->
            <div class="chess-board mb-5">
              <div
                v-for="(square, index) in board"
                :key="index"
                :class="[
                  'chess-square',
                  getSquareColor(index),
                  {
                    'selected': selectedSquare === index,
                    'valid-move': validMoves.includes(index),
                    'has-piece': validMoves.includes(index) && board[index] !== null,
                    'flash-effect': flashingSquares.includes(index)
                  }
                ]"
                @click="handleSquareClick(index)"
              >
                <span v-if="square" class="chess-piece">{% raw %}{{ getPieceEmoji(square) }}{% endraw %}</span>
              </div>
            </div>

            <!-- Control Buttons -->
            <div class="max-w-md mx-auto space-y-3">
              <button v-if="winner" @click="resetGame" class="btn btn-soft btn-success btn-block gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 -960 960 960" fill="currentColor">
                  <path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"/>
                </svg>
                New Game
              </button>
            </div>
          </div>

          <!-- Right Column - White Captured -->
          <div class="order-3 animate-slide-up h-full" style="animation-delay: 0.2s">
            <div class="h-full bg-gradient-to-br from-base-100/60 to-base-100/40 backdrop-blur-xl rounded-3xl border border-base-content/5 p-5">
              <h3 class="font-bold text-lg flex items-center gap-2 mb-4">
                <span class="text-3xl">‚ôî</span>
                <span>White</span>
              </h3>
              <div class="captured-pieces">
                <span v-for="(piece, index) in capturedPieces.white" :key="'white-' + index" class="captured-piece">
                  {% raw %}{{ piece }}{% endraw %}
                </span>
                <span v-if="capturedPieces.white.length === 0" class="text-sm opacity-40">No captures</span>
              </div>
            </div>
          </div>

        </div>
      </main>

      <!-- Floating Action Button for Power-Ups -->
      <div class="fixed bottom-6 right-6 z-50">
        <button @click="showPowerUpsModal" class="btn btn-soft btn-lg btn-circle btn-primary shadow-2xl hover:scale-110 transition-transform">
   

<svg xmlns="http://www.w3.org/2000/svg"  class="h-7 w-7" viewBox="0 -960 960 960" fill="currentColor"><path d="M346-48q-125 0-212.5-88.5T46-350q0-125 86.5-211.5T344-648h13l27-47q12-22 36-28.5t46 6.5l30 17 5-8q23-43 72-56t92 12l35 20-40 69-35-20q-14-8-30.5-3.5T570-668l-5 8 40 23q21 12 27.5 36t-5.5 45l-27 48q23 36 34.5 76.5T646-348q0 125-87.5 212.5T346-48Zm0-80q91 0 155.5-64.5T566-348q0-31-8.5-61T532-466l-26-41 42-72-104-60-42 72h-44q-94 0-163.5 60T125-350q0 92 64.5 157T346-128Zm454-480v-80h120v80H800ZM580-828v-120h80v120h-80Zm195 81-56-56 85-85 56 56-85 85ZM346-348Z"/></svg>
          <div v-if="!powerUpsUsed.white || !powerUpsUsed.black" class="absolute -top-1 -right-1 h-5 w-5 bg-error rounded-full animate-pulse"></div>
        </button>
      </div>

      <!-- Power-Ups Modal -->
      <dialog id="powerups-modal" class="modal">
        <div class="modal-box max-w-lg">
          <h3 class="font-bold text-2xl mb-2">‚≠ê Power-Ups</h3>
          <p class="text-sm opacity-70 mb-6">Each player gets one remove power-up per game!</p>
          
          <div class="space-y-4">
            <!-- White Power-Up -->
            <div class="p-5 rounded-2xl bg-base-200 border-2 transition-all" 
                 :class="currentPlayer === 'white' && !powerUpsUsed.white ? 'border-primary shadow-lg' : 'border-transparent'">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-bold flex items-center gap-2 text-lg">
                  <span class="text-3xl">‚ôî</span>
                  <span>White</span>
                </h4>
                <div class="badge" :class="powerUpsUsed.white ? 'badge-error' : 'badge-success'">
                  {% raw %}{{ powerUpsUsed.white ? 'Used ‚úì' : 'Ready' }}{% endraw %}
                </div>
              </div>
              <button
                @click="activateRemovePowerUp('white')"
                class="btn btn-soft btn-error btn-block gap-2"
                :class="{ 'btn-disabled': !canUsePowerUp('white') }"
                :disabled="!canUsePowerUp('white')"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 -960 960 960" fill="currentColor">
                  <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
                </svg>
                Remove Opponent's Piece
              </button>
            </div>

            <div class="divider">VS</div>

            <!-- Black Power-Up -->
            <div class="p-5 rounded-2xl bg-base-200 border-2 transition-all" 
                 :class="currentPlayer === 'black' && !powerUpsUsed.black ? 'border-secondary shadow-lg' : 'border-transparent'">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-bold flex items-center gap-2 text-lg">
                  <span class="text-3xl">‚ôö</span>
                  <span>Black</span>
                </h4>
                <div class="badge" :class="powerUpsUsed.black ? 'badge-error' : 'badge-success'">
                  {% raw %}{{ powerUpsUsed.black ? 'Used ‚úì' : 'Ready' }}{% endraw %}
                </div>
              </div>
              <button
                @click="activateRemovePowerUp('black')"
                class="btn btn-soft btn-error btn-block gap-2"
                :class="{ 'btn-disabled': !canUsePowerUp('black') }"
                :disabled="!canUsePowerUp('black')"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 -960 960 960" fill="currentColor">
                  <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
                </svg>
                Remove Opponent's Piece
              </button>
            </div>
          </div>

          <div class="modal-action">
            <form method="dialog">
              <button class="btn">Close</button>
            </form>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
      </dialog>

      <!-- Remove Piece Modal -->
      <dialog id="remove-modal" class="modal">
        <div class="modal-box max-w-2xl">
          <h3 class="font-bold text-2xl mb-2">üóëÔ∏è Remove Opponent's Piece</h3>
          <p class="text-sm opacity-70 mb-5">Click on an opponent's piece to remove it (cannot remove king):</p>

          <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; max-width: 500px; margin: 0 auto; border-radius: 16px; overflow: hidden;">
            <div
              v-for="(square, index) in board"
              :key="'remove-' + index"
              :class="[
                'chess-square',
                getSquareColor(index),
                {
                  'cursor-pointer hover:scale-95': canRemovePiece(index),
                  'opacity-40 cursor-not-allowed': !canRemovePiece(index)
                }
              ]"
              @click="removePiece(index)"
              style="aspect-ratio: 1; font-size: 2rem; transition: all 0.2s;"
            >
              <span v-if="square" class="chess-piece">{% raw %}{{ getPieceEmoji(square) }}{% endraw %}</span>
            </div>
          </div>

          <div class="modal-action">
            <form method="dialog">
              <button class="btn">Cancel</button>
            </form>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
      </dialog>

      <!-- Multiplayer Modal -->
      <dialog id="multiplayer-modal" class="modal">
        <div class="modal-box">
          <h3 class="font-bold text-2xl mb-4">üåê Multiplayer Chess</h3>
          
          <div class="tabs tabs-boxed mb-5">
            <a class="tab tab-lg" :class="{'tab-active': !isHost}" @click="isHost = false">Join Game</a>
            <a class="tab tab-lg" :class="{'tab-active': isHost}" @click="isHost = true">Create Game</a>
          </div>

          <!-- Create Game Tab -->
          <div v-if="isHost" class="space-y-4">
            <div class="alert alert-info">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>You'll play as White ‚ôî</span>
            </div>

            <button v-if="!peerId" @click="createGame" class="btn btn-soft btn-primary btn-lg btn-block">
              Create Game
            </button>

            <div v-else class="space-y-4">
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-bold">Share this invite link:</span>
                </label>
                <div class="join">
                  <input type="text" :value="getInviteLink()" readonly class="input input-bordered join-item flex-1" />
                  <button @click="copyPeerIdToClipboard" class="btn btn-soft btn-primary join-item">Copy</button>
                </div>
              </div>

              <div class="alert alert-success">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Waiting for opponent to join...</span>
              </div>
            </div>
          </div>

          <!-- Join Game Tab -->
          <div v-else class="space-y-4">
            <div class="alert alert-info">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>You'll play as Black ‚ôö</span>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text font-bold">Enter Game ID:</span>
              </label>
              <input 
                v-model="peerIdToConnect" 
                type="text" 
                placeholder="Paste game ID here" 
                class="input input-bordered input-lg w-full"
              />
            </div>

            <button @click="connectToPeer" class="btn btn-soft btn-primary btn-lg btn-block" :disabled="!peerIdToConnect">
              Join Game
            </button>
          </div>

          <div class="modal-action">
            <form method="dialog">
              <button class="btn">Close</button>
            </form>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
      </dialog>

      <!-- Rules Modal -->
      <dialog id="rules-modal" class="modal">
        <div class="modal-box max-w-2xl">
          <h3 class="font-bold text-3xl mb-4">‚ôüÔ∏è How to Play</h3>
          
          <div class="space-y-6">
            <div>
              <h4 class="font-bold text-xl mb-3">Basic Rules</h4>
              <ul class="space-y-2">
                <li class="flex items-start gap-3">
                  <span class="text-primary text-xl">‚Ä¢</span>
                  <span>Click on a piece to select it</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-primary text-xl">‚Ä¢</span>
                  <span>Valid moves will be highlighted with green dots</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-primary text-xl">‚Ä¢</span>
                  <span>Click on a highlighted square to move</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-primary text-xl">‚Ä¢</span>
                  <span>Capture opponent pieces by moving to their square</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-primary text-xl">‚Ä¢</span>
                  <span>Checkmate the opponent's king to win!</span>
                </li>
              </ul>
            </div>

            <div class="divider"></div>

            <div>
              <h4 class="font-bold text-xl mb-3">Power-Up: Remove Piece üóëÔ∏è</h4>
              <ul class="space-y-2">
                <li class="flex items-start gap-3">
                  <span class="text-error text-xl">‚Ä¢</span>
                  <span>Each player gets ONE remove power-up per game</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-error text-xl">‚Ä¢</span>
                  <span>Click the "Power-Ups" button to activate</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-error text-xl">‚Ä¢</span>
                  <span>Select any opponent's piece to remove it instantly</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-error text-xl">‚Ä¢</span>
                  <span>Cannot remove the opponent's king</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="text-error text-xl">‚Ä¢</span>
                  <span>Use it strategically to gain an advantage!</span>
                </li>
              </ul>
            </div>

            <div class="divider"></div>

            <div>
              <h4 class="font-bold text-xl mb-3">Chess Pieces</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="flex items-center gap-3 p-3 bg-base-200 rounded-xl">
                  <span class="text-3xl">‚ôî/‚ôö</span>
                  <div>
                    <div class="font-bold">King</div>
                    <div class="text-sm opacity-70">One square in any direction</div>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-base-200 rounded-xl">
                  <span class="text-3xl">‚ôï/‚ôõ</span>
                  <div>
                    <div class="font-bold">Queen</div>
                    <div class="text-sm opacity-70">Any distance, any direction</div>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-base-200 rounded-xl">
                  <span class="text-3xl">‚ôñ/‚ôú</span>
                  <div>
                    <div class="font-bold">Rook</div>
                    <div class="text-sm opacity-70">Horizontal or vertical</div>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-base-200 rounded-xl">
                  <span class="text-3xl">‚ôó/‚ôù</span>
                  <div>
                    <div class="font-bold">Bishop</div>
                    <div class="text-sm opacity-70">Diagonal only</div>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-base-200 rounded-xl">
                  <span class="text-3xl">‚ôò/‚ôû</span>
                  <div>
                    <div class="font-bold">Knight</div>
                    <div class="text-sm opacity-70">L-shape movement</div>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-base-200 rounded-xl">
                  <span class="text-3xl">‚ôô/‚ôü</span>
                  <div>
                    <div class="font-bold">Pawn</div>
                    <div class="text-sm opacity-70">Forward one (two on first move)</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-action">
            <form method="dialog">
              <button class="btn btn-soft btn-primary btn-lg">Got it!</button>
            </form>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
      </dialog>

    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            board: [],
            currentPlayer: 'white',
            selectedSquare: null,
            validMoves: [],
            capturedPieces: { white: [], black: [] },
            powerUpsUsed: { white: false, black: false },
            removeModeActive: false,
            removeModePlayer: null,
            winner: null,
            isCheck: false,
            flashingSquares: [],
            moveHistory: [],
            gameMode: 'local',
            peer: null,
            conn: null,
            peerId: '',
            peerIdToConnect: '',
            isHost: false,
            myColor: null
          };
        },

        computed: {
          isMultiplayer() {
            return this.gameMode === 'multiplayer' && this.conn !== null;
          },
          isMyTurn() {
            if (this.gameMode === 'local') return true;
            if (!this.isMultiplayer) return false;
            return (this.isHost && this.currentPlayer === 'white') || (!this.isHost && this.currentPlayer === 'black');
          }
        },

        methods: {
          initializeBoard() {
            this.board = [
              { type: 'rook', color: 'black' }, { type: 'knight', color: 'black' }, { type: 'bishop', color: 'black' }, { type: 'queen', color: 'black' },
              { type: 'king', color: 'black' }, { type: 'bishop', color: 'black' }, { type: 'knight', color: 'black' }, { type: 'rook', color: 'black' },
              ...Array(8).fill({ type: 'pawn', color: 'black' }),
              ...Array(32).fill(null),
              ...Array(8).fill({ type: 'pawn', color: 'white' }),
              { type: 'rook', color: 'white' }, { type: 'knight', color: 'white' }, { type: 'bishop', color: 'white' }, { type: 'queen', color: 'white' },
              { type: 'king', color: 'white' }, { type: 'bishop', color: 'white' }, { type: 'knight', color: 'white' }, { type: 'rook', color: 'white' }
            ];
          },

          getSquareColor(index) {
            const row = Math.floor(index / 8);
            const col = index % 8;
            return (row + col) % 2 === 0 ? 'light' : 'dark';
          },

          getPieceEmoji(piece) {
            if (!piece) return '';
            const pieces = {
              white: { king: '‚ôî', queen: '‚ôï', rook: '‚ôñ', bishop: '‚ôó', knight: '‚ôò', pawn: '‚ôô' },
              black: { king: '‚ôö', queen: '‚ôõ', rook: '‚ôú', bishop: '‚ôù', knight: '‚ôû', pawn: '‚ôü' }
            };
            return pieces[piece.color][piece.type];
          },

          handleSquareClick(index) {
            if (this.winner || !this.isMyTurn) return;
            const piece = this.board[index];

            if (this.selectedSquare !== null) {
              if (this.validMoves.includes(index)) {
                this.makeMove(this.selectedSquare, index);
                this.selectedSquare = null;
                this.validMoves = [];
              } else if (piece && piece.color === this.currentPlayer) {
                this.selectSquare(index);
              } else {
                this.selectedSquare = null;
                this.validMoves = [];
              }
            } else if (piece && piece.color === this.currentPlayer) {
              this.selectSquare(index);
            }
          },

          selectSquare(index) {
            this.selectedSquare = index;
            this.validMoves = this.getValidMoves(index);
          },

          getValidMoves(index) {
            const piece = this.board[index];
            if (!piece) return [];
            const row = Math.floor(index / 8);
            const col = index % 8;
            
            switch (piece.type) {
              case 'pawn': return this.getPawnMoves(index, row, col, piece.color);
              case 'rook': return this.getRookMoves(index, row, col, piece.color);
              case 'knight': return this.getKnightMoves(index, row, col, piece.color);
              case 'bishop': return this.getBishopMoves(index, row, col, piece.color);
              case 'queen': return this.getQueenMoves(index, row, col, piece.color);
              case 'king': return this.getKingMoves(index, row, col, piece.color);
              default: return [];
            }
          },

          getPawnMoves(index, row, col, color) {
            const moves = [];
            const dir = color === 'white' ? -1 : 1;
            const startRow = color === 'white' ? 6 : 1;
            const fwd = index + (dir * 8);
            
            if (fwd >= 0 && fwd < 64 && !this.board[fwd]) {
              moves.push(fwd);
              if (row === startRow) {
                const fwd2 = index + (dir * 16);
                if (!this.board[fwd2]) moves.push(fwd2);
              }
            }
            
            const lCap = fwd - 1;
            const rCap = fwd + 1;
            if (col > 0 && this.board[lCap]?.color !== color && this.board[lCap]) moves.push(lCap);
            if (col < 7 && this.board[rCap]?.color !== color && this.board[rCap]) moves.push(rCap);
            
            return moves;
          },

          getRookMoves(index, row, col, color) {
            return this.getLineMoves(index, row, col, color, [[-1, 0], [1, 0], [0, -1], [0, 1]]);
          },

          getBishopMoves(index, row, col, color) {
            return this.getLineMoves(index, row, col, color, [[-1, -1], [-1, 1], [1, -1], [1, 1]]);
          },

          getQueenMoves(index, row, col, color) {
            return [...this.getRookMoves(index, row, col, color), ...this.getBishopMoves(index, row, col, color)];
          },

          getLineMoves(index, row, col, color, dirs) {
            const moves = [];
            for (const [dr, dc] of dirs) {
              let r = row + dr, c = col + dc;
              while (r >= 0 && r < 8 && c >= 0 && c < 8) {
                const i = r * 8 + c;
                const p = this.board[i];
                if (!p) moves.push(i);
                else {
                  if (p.color !== color) moves.push(i);
                  break;
                }
                r += dr; c += dc;
              }
            }
            return moves;
          },

          getKnightMoves(index, row, col, color) {
            const moves = [];
            const offsets = [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];
            for (const [dr, dc] of offsets) {
              const r = row + dr, c = col + dc;
              if (r >= 0 && r < 8 && c >= 0 && c < 8) {
                const i = r * 8 + c;
                const p = this.board[i];
                if (!p || p.color !== color) moves.push(i);
              }
            }
            return moves;
          },

          getKingMoves(index, row, col, color) {
            const moves = [];
            const offsets = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            for (const [dr, dc] of offsets) {
              const r = row + dr, c = col + dc;
              if (r >= 0 && r < 8 && c >= 0 && c < 8) {
                const i = r * 8 + c;
                const p = this.board[i];
                if (!p || p.color !== color) moves.push(i);
              }
            }
            return moves;
          },

          makeMove(fromIndex, toIndex) {
            const piece = this.board[fromIndex];
            const captured = this.board[toIndex];

            if (captured) {
              this.capturedPieces[this.currentPlayer].push(this.getPieceEmoji(captured));
              this.flashSquare(toIndex);
            }

            this.board[toIndex] = piece;
            this.board[fromIndex] = null;
            this.flashSquare(toIndex);
            this.checkGameState();

            if (!this.winner) {
              this.currentPlayer = this.currentPlayer === 'white' ? 'black' : 'white';
            }

            if (this.isMultiplayer && this.conn?.open) {
              this.conn.send({
                type: 'move',
                board: [...this.board],
                currentPlayer: this.currentPlayer,
                capturedPieces: { ...this.capturedPieces },
                winner: this.winner
              });
            }
          },

          checkGameState() {
            const opp = this.currentPlayer === 'white' ? 'black' : 'white';
            const kingIdx = this.board.findIndex(p => p?.type === 'king' && p.color === opp);
            if (kingIdx === -1) {
              this.winner = this.currentPlayer;
              this.toaster(`üèÜ ${this.currentPlayer === 'white' ? '‚ôî White' : '‚ôö Black'} wins!`, 'success', 5000);
              this.celebrationFireworks();
            }
          },

          canUsePowerUp(player) {
            return !this.powerUpsUsed[player] && this.currentPlayer === player && !this.winner && this.isMyTurn;
          },

          activateRemovePowerUp(player) {
            if (!this.canUsePowerUp(player)) return;
            this.removeModeActive = true;
            this.removeModePlayer = player;
            document.getElementById('powerups-modal').close();
            document.getElementById('remove-modal').showModal();
          },

          canRemovePiece(index) {
            if (!this.removeModeActive) return false;
            const p = this.board[index];
            if (!p) return false;
            const opp = this.removeModePlayer === 'white' ? 'black' : 'white';
            return p.color === opp && p.type !== 'king';
          },

          removePiece(index) {
            if (!this.canRemovePiece(index)) return;
            
            const piece = this.board[index];
            this.capturedPieces[this.removeModePlayer].push(this.getPieceEmoji(piece));
            this.board[index] = null;
            this.powerUpsUsed[this.removeModePlayer] = true;
            this.flashSquare(index);
            
            document.getElementById('remove-modal').close();
            this.removeModeActive = false;
            this.removeModePlayer = null;
            
            this.toaster('Remove power-up used!', 'warning', 2000);
            this.currentPlayer = this.currentPlayer === 'white' ? 'black' : 'white';

            if (this.isMultiplayer && this.conn?.open) {
              this.conn.send({
                type: 'powerup',
                board: [...this.board],
                currentPlayer: this.currentPlayer,
                capturedPieces: { ...this.capturedPieces },
                powerUpsUsed: { ...this.powerUpsUsed }
              });
            }
          },

          flashSquare(index) {
            this.flashingSquares.push(index);
            setTimeout(() => {
              this.flashingSquares = this.flashingSquares.filter(i => i !== index);
            }, 450);
          },

          resetGame() {
            this.initializeBoard();
            this.currentPlayer = 'white';
            this.selectedSquare = null;
            this.validMoves = [];
            this.capturedPieces = { white: [], black: [] };
            this.powerUpsUsed = { white: false, black: false };
            this.removeModeActive = false;
            this.removeModePlayer = null;
            this.winner = null;
            this.flashingSquares = [];
            this.moveHistory = [];
            
            this.toaster('New game started!', 'info');

            if (this.isMultiplayer && this.conn?.open) {
              this.conn.send({ type: 'reset' });
            }
          },

          setGameMode(mode) {
            this.gameMode = mode;
            if (mode === 'multiplayer') {
              this.showMultiplayerModal();
            } else {
              if (this.conn) this.conn.close();
              if (this.peer) this.peer.destroy();
              this.conn = null;
              this.peer = null;
            }
            this.resetGame();
          },

          showMultiplayerModal() { document.getElementById('multiplayer-modal').showModal(); },
          showPowerUpsModal() { document.getElementById('powerups-modal').showModal(); },
          showRulesModal() { document.getElementById('rules-modal').showModal(); },

          createGame() {
            if (this.peer) this.peer.destroy();
            this.isHost = true;
            this.peer = new Peer();
            
            this.peer.on('open', (id) => {
              this.peerId = id;
              this.toaster('Game created! Share the link.', 'success');
            });
            
            this.peer.on('connection', (conn) => {
              conn.on('open', () => {
                this.conn = conn;
                this.setupConnection();
                this.toaster('Opponent joined!', 'success');
                document.getElementById('multiplayer-modal').close();
              });
            });
          },

          connectToPeer() {
            if (!this.peerIdToConnect.trim()) return;
            this.isHost = false;
            this.peer = new Peer();
            
            this.peer.on('open', () => {
              this.conn = this.peer.connect(this.peerIdToConnect);
              
              this.conn.on('open', () => {
                this.setupConnection();
                this.toaster('Connected to game!', 'success');
                document.getElementById('multiplayer-modal').close();
              });
            });
          },

          setupConnection() {
            this.conn.on('data', (data) => {
              if (data.type === 'move') {
                this.board = [...data.board];
                this.currentPlayer = data.currentPlayer;
                this.capturedPieces = { ...data.capturedPieces };
                this.winner = data.winner;
                this.selectedSquare = null;
                this.validMoves = [];
              } else if (data.type === 'powerup') {
                this.board = [...data.board];
                this.currentPlayer = data.currentPlayer;
                this.capturedPieces = { ...data.capturedPieces };
                this.powerUpsUsed = { ...data.powerUpsUsed };
              } else if (data.type === 'reset') {
                this.resetGame();
              }
            });
          },

          getInviteLink() {
            return `${window.location.origin}${window.location.pathname}?gameId=${this.peerId}`;
          },

          copyPeerIdToClipboard() {
            navigator.clipboard.writeText(this.getInviteLink())
              .then(() => this.toaster('Link copied to clipboard!', 'success'))
              .catch(() => this.toaster('Failed to copy', 'error'));
          },

          toaster(msg, type = 'info', duration = 3000) {
            const colors = { info: '#3b82f6', success: '#10b981', warning: '#f59e0b', error: '#ef4444' };
            if (window.Toastify) {
              window.Toastify({
                text: msg,
                duration,
                gravity: 'bottom',
                position: 'center',
                backgroundColor: colors[type],
                className: 'rounded-xl shadow-lg'
              }).showToast();
            }
          },

          celebrationFireworks() {
            if (typeof confetti === 'undefined') return;
            const duration = 3000;
            const end = Date.now() + duration;
            
            const interval = setInterval(() => {
              if (Date.now() > end) return clearInterval(interval);
              
              confetti({
                particleCount: 50,
                startVelocity: 30,
                spread: 360,
                origin: { x: Math.random(), y: Math.random() - 0.2 }
              });
            }, 250);
          }
        },

        mounted() {
          this.initializeBoard();
          this.toaster('Welcome to Tactical Chess! ‚ôüÔ∏è', 'success', 3000);

          const gameId = new URLSearchParams(window.location.search).get('gameId');
          if (gameId) {
            this.peerIdToConnect = gameId;
            this.gameMode = 'multiplayer';
            setTimeout(() => this.connectToPeer(), 1000);
          }
        },

        beforeUnmount() {
          if (this.conn) this.conn.close();
          if (this.peer) this.peer.destroy();
        }
      }).mount('#app');
    </script>
  </body>
</html>